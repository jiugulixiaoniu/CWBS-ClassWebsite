name: Push Dist to Target Repo

on: [push]

jobs:
  push-dist:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Build Project
        run: |
          npm install && npm run build
      
      - name: Init Git in dist & Configure SSH (Full Fix)
        run: |
          # 1. 确保 .ssh 目录存在并设置严格权限（基础前提）
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          
          # 2. 写入 SSH 私钥（关键：保留私钥原始格式，避免转义问题）
          cat << 'EOF' > ~/.ssh/id_ed25519
          ${{ secrets.SSH_PRIVATE_KEY }}
          EOF
          
          # 3. 强制设置私钥 600 权限（SSH 强制要求，不可修改）
          chmod 600 ~/.ssh/id_ed25519
          
          # 4. 验证私钥文件是否存在且格式正确（调试用，可选保留）
          ls -la ~/.ssh/
          cat ~/.ssh/id_ed25519 | head -n 2
          
          # 5. 初始化 dist 目录 Git 仓库
          cd dist
          git init -b main
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git remote add origin git@github.com:jiugulixiaoniu/cwBs-classwebsite-show.git
      
      - name: Push to Target (Fix SSH Authentication)
        run: |
          # 1. 完整获取 GitHub 主机密钥，写入 known_hosts（避免验证遗漏）
          ssh-keyscan -H github.com >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts
          
          # 2. 配置 SSH 客户端，强制使用指定私钥（核心修复：避免 SSH 找不到私钥）
          cat << 'EOF' > ~/.ssh/config
          Host github.com
            HostName github.com
            User git
            IdentityFile ~/.ssh/id_ed25519
            StrictHostKeyChecking yes
            UserKnownHostsFile ~/.ssh/known_hosts
          EOF
          chmod 600 ~/.ssh/config
          
          # 3. 验证 SSH 连接（先排查连接问题，再执行 Git 操作）
          ssh -T git@github.com || echo "SSH 连接验证失败，继续排查密钥问题"
          
          # 4. 提交并强制推送代码
          cd dist
          git add -A
          git commit -m "Deploy: ${{ github.sha }}"
          git push origin main --force
